(()=>{var e={};e.id=146,e.ids=[146],e.modules={6037:e=>{"use strict";e.exports=require("mongoose")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},6368:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>h,routeModule:()=>l,serverHooks:()=>S,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>y});var n={};r.r(n),r.d(n,{POST:()=>m,runtime:()=>c});var i=r(1271),a=r(1232),d=r(8079),s=r(6037),u=r(3418),p=r(9999),o=r(2907);let c="nodejs";async function m(e){await (0,u.T)();let t=await e.json(),r=t.userId?{userId:t.userId}:{sessionId:t.sessionId};if(!r.userId&&!r.sessionId)return new Response(JSON.stringify({message:"userId atau sessionId wajib"}),{status:400});let n=await p.Z3.findOne(r).lean();if(!n||0===n.items.length)return new Response(JSON.stringify({message:"Cart kosong"}),{status:400});let i=n.items.reduce((e,t)=>e+t.priceSnapshot.unit*t.qty,0),a=i+25e3,d=await s.startSession();try{let e;return await d.withTransaction(async()=>{for(let e of n.items){let t=await p.rI.findOne({productId:e.productId,variantId:e.variantId}).session(d);if(!t)throw Error("Inventory not found");if((t.onHand||0)-(t.reserved||0)<e.qty)throw Error(`Stok kurang untuk ${e.sku||e.variantId}`);t.reserved+=e.qty,await t.save({session:d})}let s=(0,o.K)();e=(await p.pH.create([{orderNo:s,userId:t.userId||null,status:"awaiting_payment",channel:"web",items:n.items.map(e=>({productId:e.productId,variantId:e.variantId,sku:e.sku,title:e.title,variantLabel:e.variantLabel,qty:e.qty,price:{currency:e.priceSnapshot.currency,unit:e.priceSnapshot.unit,subtotal:e.priceSnapshot.unit*e.qty}})),pricing:{subtotal:i,discounts:[],shippingCost:25e3,tax:0,grandTotal:a},shippingAddress:t.shippingAddress,billingAddress:t.billingAddress||t.shippingAddress,payment:{method:t.paymentMethod,status:"pending"},shipment:{courier:t.courier,service:t.service},placedAt:new Date}],{session:d}))[0],await p.p2.create([{orderId:e._id,provider:"Manual",method:t.paymentMethod,amount:a,status:"pending",externalRef:`CHK-${e.orderNo}`}],{session:d}),await p.Z3.deleteOne(r).session(d)}),Response.json({orderId:e._id,orderNo:e.orderNo,grandTotal:a})}catch(e){return console.error(e),new Response(JSON.stringify({message:e.message||"Checkout gagal"}),{status:400})}finally{d.endSession()}}let l=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/checkout/route",pathname:"/api/checkout",filename:"route",bundlePath:"app/api/checkout/route"},resolvedPagePath:"C:\\Users\\imamb\\Desktop\\QuickCart\\apps\\backend\\app\\api\\checkout\\route.js",nextConfigOutput:"",userland:n}),{workAsyncStorage:g,workUnitAsyncStorage:y,serverHooks:S}=l;function h(){return(0,d.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:y})}},7032:()=>{},408:()=>{},1271:(e,t,r)=>{"use strict";e.exports=r(4870)},3418:(e,t,r)=>{"use strict";r.d(t,{T:()=>d});var n=r(6037);let i=process.env.MONGODB_URI||"mongodb://localhost:27017/GalaTech";if(console.log(i,"ini MONGODB_URI"),!i)throw Error("Please define the MONGODB_URI env var in .env.local");let a=global.mongoose;async function d(){return a.conn||(a.promise||(a.promise=n.connect(i,{bufferCommands:!1,dbName:process.env.MONGODB_DB,maxPoolSize:10}).then(e=>e)),a.conn=await a.promise),a.conn}a||(a=global.mongoose={conn:null,promise:null})},9999:(e,t,r)=>{"use strict";r.d(t,{mz:()=>u,Z3:()=>b,b7:()=>o,rI:()=>S,pH:()=>x,p2:()=>O,Yt:()=>g,p_:()=>q,KJ:()=>d,ar:()=>k});var n=r(6037);let i=new n.Schema({label:String,receiver_name:String,phone:String,street:String,subdistrict:String,city:String,province:String,postal_code:String,country:{type:String,default:"ID"},is_default:{type:Boolean,default:!1},geo:{lat:Number,lng:Number}},{_id:!0}),a=new n.Schema({email:{type:String,index:!0,unique:!0,sparse:!0},phone:{type:String,index:!0,unique:!0,sparse:!0},name:String,password_hash:String,roles:{type:[String],default:["customer"]},status:{type:String,enum:["active","blocked","deleted"],default:"active"},default_address_id:{type:n.Schema.Types.ObjectId},addresses:[i]},{timestamps:!0}),d=n.models.User||n.model("User",a),s=new n.Schema({slug:{type:String,unique:!0,index:!0},name:{type:String,required:!0},logo_url:String,logo_public_id:{type:String,default:""},country:String,status:{type:String,enum:["active","inactive"],default:"active"}},{timestamps:!0});s.index({name:"text"});let u=n.models.Brand||n.model("Brand",s),p=new n.Schema({slug:{type:String,unique:!0,index:!0},name:{type:String,required:!0},image:{type:String,required:!0},parent_id:{type:n.Schema.Types.ObjectId,ref:"Category",default:null},ancestors:[{_id:{type:n.Schema.Types.ObjectId,ref:"Category"},name:String,slug:String}],order:{type:Number,default:0}},{timestamps:!0});p.index({parent_id:1,order:1});let o=n.models.Category||n.model("Category",p),c=new n.Schema({url:String,alt:String},{_id:!1}),m=new n.Schema({sku:{type:String,index:!0,unique:!0},options:{type:n.Schema.Types.Mixed},price:{currency:{type:String,default:"IDR"},list:{type:Number,required:!0},sale:{type:Number,default:null},startAt:Date,endAt:Date},weightGram:Number,dimensionsCm:{l:Number,w:Number,h:Number},barcode:String,status:{type:String,enum:["active","inactive"],default:"active"}},{_id:!0}),l=new n.Schema({slug:{type:String,unique:!0,index:!0},sku:String,title:{type:String,required:!0},subtitle:String,brandId:{type:n.Schema.Types.ObjectId,ref:"Brand"},categoryIds:[{type:n.Schema.Types.ObjectId,ref:"Category"}],descriptionHtml:String,media:[c],attributes:n.Schema.Types.Mixed,variants:{type:[m],validate:e=>e.length>0},seo:{title:String,metaDescription:String},status:{type:String,enum:["active","draft","archived"],default:"active"},rating:{avg:{type:Number,default:0},count:{type:Number,default:0}},soldCount:{type:Number,default:0},viewCount:{type:Number,default:0}},{timestamps:!0});l.index({title:"text"}),l.index({brandId:1}),l.index({categoryIds:1}),l.index({status:1}),l.index({updatedAt:-1});let g=n.models.Product||(0,n.model)("Product",l),y=new n.Schema({product_id:{type:n.Schema.Types.ObjectId,ref:"Product",index:!0},variant_id:{type:n.Schema.Types.ObjectId,index:!0},warehouse_id:{type:String,default:"JKT-01"},on_hand:{type:Number,default:0},reserved:{type:Number,default:0}},{timestamps:!0});y.index({product_id:1,variant_id:1,warehouse_id:1},{unique:!0});let S=n.models.Inventory||n.model("Inventory",y),h=new n.Schema({productId:{type:n.Schema.Types.ObjectId,ref:"Product"},variantId:{type:n.Schema.Types.ObjectId},sku:String,title:String,variantLabel:String,qty:{type:Number,default:1},priceSnapshot:{currency:String,unit:Number},addedAt:{type:Date,default:Date.now}},{_id:!0}),f=new n.Schema({userId:{type:n.Schema.Types.ObjectId,ref:"User",index:!0},sessionId:{type:String,index:!0},items:[h],couponCodes:[String],notes:String},{timestamps:!0}),b=n.models.Cart||(0,n.model)("Cart",f),I=new n.Schema({productId:{type:n.Schema.Types.ObjectId,ref:"Product"},variantId:{type:n.Schema.Types.ObjectId},sku:String,title:String,variantLabel:String,qty:{type:Number,required:!0},price:{currency:{type:String,default:"IDR"},unit:{type:Number,required:!0},subtotal:{type:Number,required:!0}},weightGram:Number},{_id:!0}),v=new n.Schema({receiverName:String,phone:String,street:String,subdistrict:String,city:String,province:String,postalCode:String,country:String},{_id:!1}),w=new n.Schema({orderNo:{type:String,unique:!0,index:!0},userId:{type:n.Schema.Types.ObjectId,ref:"User",index:!0},status:{type:String,enum:["awaiting_payment","paid","processing","shipped","completed","cancelled","refunded"],default:"awaiting_payment"},channel:{type:String,default:"web"},items:[I],pricing:{subtotal:Number,discounts:[{code:String,amount:Number}],shippingCost:Number,tax:Number,grandTotal:Number},shippingAddress:v,billingAddress:v,payment:{paymentId:{type:n.Schema.Types.ObjectId,ref:"Payment"},method:String,status:{type:String,enum:["pending","paid","failed","expired"],default:"pending"}},shipment:{shipmentId:{type:n.Schema.Types.ObjectId,ref:"Shipment"},courier:String,service:String,trackingNo:String},placedAt:{type:Date,default:Date.now}},{timestamps:!0});w.index({userId:1,placedAt:-1}),w.index({status:1,placedAt:-1});let x=n.models.Order||(0,n.model)("Order",w),N=new n.Schema({orderId:{type:n.Schema.Types.ObjectId,ref:"Order",unique:!0},provider:String,method:String,amount:Number,currency:{type:String,default:"IDR"},status:{type:String,enum:["pending","paid","failed","expired","refunded"],default:"pending"},externalRef:{type:String,index:!0},vaNumber:String,paidAt:Date,raw:n.Schema.Types.Mixed},{timestamps:!0});N.index({status:1,createdAt:-1});let O=n.models.Payment||(0,n.model)("Payment",N),_=new n.Schema({status:String,at:Date},{_id:!1}),T=new n.Schema({orderId:{type:n.Schema.Types.ObjectId,ref:"Order",unique:!0},warehouseId:{type:String,default:"MAIN"},courier:String,service:String,trackingNo:{type:String,unique:!0,sparse:!0},status:{type:String,enum:["packed","shipped","in_transit","delivered","failed"],default:"packed"},history:[_]},{timestamps:!0});n.models.Shipment||(0,n.model)("Shipment",T);let j=new n.Schema({product_id:{type:n.Schema.Types.ObjectId,ref:"Product",index:!0},variant_id:{type:n.Schema.Types.ObjectId},order_id:{type:n.Schema.Types.ObjectId,ref:"Order"},user_id:{type:n.Schema.Types.ObjectId,ref:"User"},rating:{type:Number,min:1,max:5},title:String,content:String,media:[{url:String}],helpful_count:{type:Number,default:0},status:{type:String,enum:["pending","published","rejected"],default:"pending"}},{timestamps:!0});j.index({status:1,createdAt:-1});let q=n.models.Review||n.model("Review",j),A=new n.Schema({userId:{type:n.Schema.Types.ObjectId,ref:"User",unique:!0},items:[{productId:{type:n.Schema.Types.ObjectId,ref:"Product"},addedAt:{type:Date,default:Date.now}}]},{timestamps:!0}),k=n.models.Wishlist||(0,n.model)("Wishlist",A),D=new n.Schema({code:{type:String,unique:!0,index:!0},type:{type:String,enum:["flat","percent","shipping","bundle"],default:"flat"},value:Number,minOrder:{type:Number,default:0},maxDiscount:{type:Number,default:null},startAt:Date,endAt:Date,usageLimit:Number,usageCount:{type:Number,default:0},constraints:{brandIds:[n.Schema.Types.ObjectId],categoryIds:[n.Schema.Types.ObjectId],firstOrderOnly:{type:Boolean,default:!1}},status:{type:String,enum:["active","inactive"],default:"active"}},{timestamps:!0});D.index({status:1,startAt:1,endAt:1}),n.models.Coupon||(0,n.model)("Coupon",D);let C=new n.Schema({slot:{type:String,index:!0},title:String,imageUrl:String,linkUrl:String,startAt:Date,endAt:Date,priority:{type:Number,default:0},status:{type:String,enum:["active","inactive"],default:"active"}},{timestamps:!0});C.index({slot:1,status:1,startAt:1,endAt:1}),n.models.Banner||(0,n.model)("Banner",C);let R=new n.Schema({type:{type:String,index:!0},ref:{type:n.Schema.Types.Mixed},userId:{type:n.Schema.Types.ObjectId,ref:"User"},meta:n.Schema.Types.Mixed},{timestamps:{createdAt:!0,updatedAt:!1}});R.index({"ref.orderId":1,createdAt:-1}),R.index({createdAt:-1}),n.models.Event||(0,n.model)("Event",R);let M=new n.Schema({orderItemSku:String,qty:Number,reason:String},{_id:!1}),P=new n.Schema({orderId:{type:n.Schema.Types.ObjectId,ref:"Order"},items:[M],status:{type:String,enum:["requested","approved","rejected","received","refunded"],default:"requested"},refund:{amount:Number,method:{type:String,default:"original"}}},{timestamps:!0});n.models.Return||(0,n.model)("Return",P)},2907:(e,t,r)=>{"use strict";function n(e=new Date){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),a=((e,t=6)=>String(e).padStart(t,"0"))(Math.floor(1e6*Math.random()));return`AG-${t}${r}${i}-${a}`}r.d(t,{K:()=>n})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[79],()=>r(6368));module.exports=n})();