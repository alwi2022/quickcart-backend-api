"use strict";(()=>{var e={};e.id=789,e.ids=[789],e.modules={6037:e=>{e.exports=require("mongoose")},846:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9294:e=>{e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},9428:e=>{e.exports=require("buffer")},5511:e=>{e.exports=require("crypto")},7910:e=>{e.exports=require("stream")},8354:e=>{e.exports=require("util")},6004:(e,t,r)=>{r.r(t),r.d(t,{patchFetch:()=>x,routeModule:()=>w,serverHooks:()=>f,workAsyncStorage:()=>j,workUnitAsyncStorage:()=>v});var i={};r.r(i),r.d(i,{GET:()=>h,POST:()=>k,runtime:()=>g});var a=r(1271),n=r(1232),s=r(8079),o=r(3418),d=r(9999),u=r(3947),p=r(4807),l=r(2907);async function m(e){for(let t of e){let e=await d.rI.findOne({product_id:t.productId,variant_id:t.variantId,sku:t.sku,warehouse:"main"});if((e?.qty??0)<t.qty)throw new u.v7(`Stok tidak cukup untuk SKU ${t.sku}`)}await Promise.all(e.map(e=>d.rI.updateOne({product_id:e.productId,variant_id:e.variantId,sku:e.sku,warehouse:"main"},{$inc:{qty:-e.qty}})))}var c=r(7001);let g="nodejs";async function h(e){try{await (0,o.T)();let t=(0,c.JR)(),{searchParams:r}=new URL(e.url),i=Math.max(1,Number(r.get("page")||1)),a=Math.min(50,Math.max(1,Number(r.get("limit")||20))),[n,s]=await Promise.all([d.pH.find({userId:t.sub}).sort({placedAt:-1}).skip((i-1)*a).limit(a).select("orderNo status pricing placedAt items payment.shipment").lean(),d.pH.countDocuments({userId:t.sub})]);return(0,u.Pq)({items:n,total:s,page:i,pages:Math.ceil(s/a)})}catch(e){return(0,u.hS)(e)}}async function k(e){try{await (0,o.T)();let t=(0,c.JR)(),r=await e.json(),i=p.ie.parse(r),a=[...new Set(i.items.map(e=>e.productId))],n=await d.Yt.find({_id:{$in:a}}).lean(),s=i.items.map(e=>{let t=n.find(t=>String(t._id)===String(e.productId));if(!t)throw new u.v7(`Produk tidak ditemukan: ${e.productId}`);let r=(t.variants||[]).find(t=>String(t._id)===String(e.variantId));if(!r)throw new u.v7(`Varian tidak ditemukan untuk produk ${t.title}`);let i=function(e){let t=e?.price?.sale,r=e?.price?.list??0;return null!=t&&""!==t?Number(t):Number(r)}(r),a=i*e.qty;return{productId:t._id,variantId:r._id,sku:r.sku,title:t.title,variantLabel:[r.options?.color,r.options?.size].filter(Boolean).join(" / "),qty:e.qty,price:{currency:r.price?.currency||"IDR",unit:i,subtotal:a},weightGram:r.weightGram??0}}),g=s.reduce((e,t)=>e+t.price.subtotal,0),h=Number(i.shippingCost||0),k=Number(i.tax||0),w=[],j=g+h+k-w.reduce((e,t)=>e+(t.amount||0),0);await m(s);let v=await (0,l.K)(),f=await d.pH.create({orderNo:v,userId:t.sub,status:"awaiting_payment",channel:i.channel||"web",items:s,pricing:{subtotal:g,discounts:w,shippingCost:h,tax:k,grandTotal:j},shippingAddress:i.shippingAddress,billingAddress:i.billingAddress||i.shippingAddress,payment:{method:i.paymentMethod||"manual",status:"pending"},shipment:{},placedAt:new Date});return(0,u.Pq)({item:f},{status:201})}catch(e){return(0,u.hS)(e)}}let w=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/orders/route",pathname:"/api/orders",filename:"route",bundlePath:"app/api/orders/route"},resolvedPagePath:"C:\\Users\\imamb\\Desktop\\QuickCart\\apps\\backend\\app\\api\\orders\\route.js",nextConfigOutput:"",userland:i}),{workAsyncStorage:j,workUnitAsyncStorage:v,serverHooks:f}=w;function x(){return(0,s.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:v})}},2907:(e,t,r)=>{r.d(t,{K:()=>i});function i(e=new Date){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0"),n=((e,t=6)=>String(e).padStart(t,"0"))(Math.floor(1e6*Math.random()));return`AG-${t}${r}${a}-${n}`}},4807:(e,t,r)=>{r.d(t,{X5:()=>a,ie:()=>s,zK:()=>n});var i=r(6063);let a=i.Ik({email:i.Yj().email().toLowerCase(),password:i.Yj().min(6)}),n=i.Ik({name:i.Yj().min(2),email:i.Yj().email().toLowerCase(),password:i.Yj().min(6)});i.Ik({productId:i.Yj().min(1),userId:i.Yj().min(1),rating:i.ai().min(1).max(5),title:i.Yj().optional(),content:i.Yj().optional(),status:i.k5(["pending","published","rejected"]).optional()});let s=i.Ik({items:i.YO(i.Ik({productId:i.Yj().min(1),variantId:i.Yj().min(1),sku:i.Yj().min(1),qty:i.ai().int().positive()})).min(1),shippingAddress:i.Ik({receiverName:i.Yj().min(1),phone:i.Yj().min(6),street:i.Yj().min(3),subdistrict:i.Yj().min(1),city:i.Yj().min(1),province:i.Yj().min(1),postalCode:i.Yj().min(3),country:i.Yj().default("ID")}),billingAddress:i.bz().optional(),shippingCost:i.ai().nonnegative().default(0),tax:i.ai().nonnegative().default(0),note:i.Yj().max(500).optional(),paymentMethod:i.Yj().default("manual"),channel:i.Yj().default("web")})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[79,388,365,255,63,501],()=>r(6004));module.exports=i})();